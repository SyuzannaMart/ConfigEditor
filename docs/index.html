<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Config Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#d4f2ff;
    --card:#fff;
    --ink:#222;
    --brand:#375bdd;
    --ok:#0dcc00;
    --danger:#e53935;
    --muted:#6b7280;
    --drop:#1f2a63;
  }
  *{box-sizing:border-box}
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: var(--bg);
    padding: 20px;
    color:var(--ink);
  }
  h2{margin:0 0 12px}
  .toolbar{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0 12px;
  }
  textarea, input{
    width:100%;
    padding:8px 10px;
    margin:6px 0;
    border-radius:16px;
    background-color:aliceblue;
    border:2px solid var(--brand);
    font-size:14px;
  }
  #inputConfig, #outputConfig{min-height:200px}
  button{
    margin: 6px;
    padding:8px 14px;
    border-radius:16px;
    background: var(--brand);
    border:none;
    color:#fff;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    min-height:36px;
  }
  button.small{ padding:4px 10px; border-radius:12px; font-size:12px; min-height:auto; }
  button.ghost{ background:var(--brand); color:#fff; }
  button.ok{ background: var(--ok); }
  button.danger{ background: var(--danger); }
  #copy{ background: var(--danger); }
  #configContainer{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap:12px;
  }
  .entry{
    display:flex; flex-direction:column; gap:10px;
    background: var(--card);
    padding:12px;
    border-radius:16px;
    box-shadow: 0 0 3px rgba(0,0,0,.1);
  }
  .muted{opacity:.9; font-size:12px; color:var(--muted)}
  .title{
    padding: 20px;
    gap: 20px;
    display: flex; align-items: center; font-size: 26px;
    justify-content: center; color: #fff; margin-bottom: 16px;
    background-color:#375bdd; border-radius: 20px;
  }
  .title img{ width:60px; height:60px; }
  label{ font-size: 14px; font-weight:600; }
  .row{ display:flex; align-items:center; gap:8px; }
  .row > .grow{ flex:1; }
  img.preview{
    max-width: 100px; max-height:100px; border:1px solid #ccc; border-radius:6px;
  }
  details{
    background:#f7faff; border:1px solid #d9e3ff; border-radius:12px; padding:8px 10px; margin:6px 0;
  }
  summary{ cursor:pointer; list-style:none; font-weight:700; color:#1f2a63; }
  summary::-webkit-details-marker{ display:none; }
  .badge{ display:inline-block; background:#e9eefc; color:#1f2a63; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  .controls{ display:flex; flex-wrap:wrap; gap:6px; margin:6px 0; }
  .keyAdd{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  select{ padding:6px; border-radius:10px; border:1px solid #b9c6ff; background:#fff; }

  /* === DnD === */
  .array-list{ display:flex; flex-direction:column; gap:8px; }
  .array-item{
    border:1px dashed transparent; border-radius:12px; padding:6px;
    background:#fff; position: relative;
  }
  .array-item.dragging{ opacity:.55; }
  .array-item.drop-before{ box-shadow: 0 -3px 0 0 var(--drop) inset; }
  .array-item.drop-after{  box-shadow: 0  3px 0 0 var(--drop) inset; }
  .drag-handle{
    user-select:none; cursor:grab; font-weight:700; padding:2px 8px; border-radius:10px;
    background:#e9eefc; color:#1f2a63; margin-right:6px; display:inline-flex; align-items:center;
  }
  .top-item-wrap{ position: relative; }
  .top-item-wrap .drag-handle{ position:absolute; top:6px; right:6px; opacity:.9; }
</style>
</head>
<body>

  <div class="title">
    <img src="./img/script-programming-code-files-document-3d-object.png" alt="">
    <h2>Config editor</h2>
  </div>

  <label for="inputConfig">Paste your config here (JSON array or JS literal like <code>const config = [ ... ]</code>)</label>
  <textarea id="inputConfig" placeholder='Example: const config = [{ "imgSrc": "https://...", "title": "Foo" }];'></textarea>

  <div class="toolbar">
    <button id="loadBtn" class="ok">Import config</button>
    <button id="addItemBtn" class="ghost">Add top-level item</button>
   
    <label class="muted"><input type="checkbox" id="allowUnsafe" checked> Allow unsafe JS literal parsing</label>
  </div>

  <div id="configContainer"></div>
  <button id="exportBtn" class="ghost">Generate new code</button>
  <button id="copy" class="danger">Copy</button>
  <label for="outputConfig">Result (code to copy)</label>
  <textarea id="outputConfig" placeholder="Generated code will appear here"></textarea>

<script>
  let config = [];
  let originalAssignment = 'const config =';
  let dragCtx = null; 

  const isObj = v => v && typeof v === 'object' && !Array.isArray(v);
  const deepClone = v => (typeof structuredClone === 'function') ? structuredClone(v) : JSON.parse(JSON.stringify(v));
  function getByPath(obj, path){ return path.reduce((acc, key) => acc?.[key], obj); }
  function setByPath(obj, path, value){
    if (!path.length) return;
    const lastKey = path[path.length-1];
    const parent = getByPath(obj, path.slice(0,-1));
    if (parent && typeof parent === 'object') parent[lastKey] = value;
  }
  function deleteByPath(obj, path){
    const lastKey = path[path.length-1];
    const parent = getByPath(obj, path.slice(0,-1));
    if (Array.isArray(parent)) parent.splice(+lastKey, 1);
    else if (parent && typeof parent === 'object') delete parent[lastKey];
  }
  function ensureUniqueKey(obj, base='newKey'){
    let k = base, i = 1;
    while(Object.prototype.hasOwnProperty.call(obj, k)) k = base + '_' + (i++);
    return k;
  }
  function cloneShapeLike(x){
    if (Array.isArray(x)) return [];
    if (isObj(x)){
      const out = {};
      for (const k of Object.keys(x)){
        const v = x[k];
        if (Array.isArray(v)) out[k] = [];
        else if (isObj(v)) out[k] = cloneShapeLike(v);
        else if (typeof v === 'string') out[k] = '';
        else if (typeof v === 'number') out[k] = 0;
        else if (typeof v === 'boolean') out[k] = false;
        else out[k] = null;
      }
      return out;
    }
    if (typeof x === 'string') return '';
    if (typeof x === 'number') return 0;
    if (typeof x === 'boolean') return false;
    return null;
  }
  function makeByType(type){
    switch(type){
      case 'string': return '';
      case 'number': return 0;
      case 'boolean': return false;
      case 'object': return {};
      case 'array':  return [];
      case 'null':   return null;
      default: return '';
    }
  }
  function smartCoerce(text){
    if (text === '') return '';
    const t = String(text).trim();
    if (t === 'null') return null;
    if (t === 'true') return true;
    if (t === 'false') return false;
    if (/^-?\d+(?:\.\d+)?$/.test(t)) return Number(t);
    if (/^[\[{]/.test(t)){
      try { return JSON.parse(t); } catch {}
    }
    return text;
  }
  function prettyLabel(k){
    if (typeof k === 'number') return `Item ${k+1}`;
    return String(k).replace(/([a-z])([A-Z])/g,'$1 $2').replace(/_/g,' ').replace(/^\w/, c=>c.toUpperCase());
  }
  function isValidIdentifier(key){ return /^[A-Za-z_$][\w$]*$/.test(key); }
  function moveInArray(arr, from, to){
    if (from === to || from < 0 || to < 0 || from >= arr.length) return;
    const item = arr.splice(from, 1)[0];
    if (to > arr.length) to = arr.length;
    arr.splice(to, 0, item);
  }
  function pathKeyOf(path){ return path.map(k => String(k).replaceAll('.', '\\.')).join('.'); }

  // === image preview helpers ===
  function isLikelyImageUrl(s){
    if (typeof s !== 'string') return false;
    const u = s.trim();
    if (!u) return false;
    if (/^data:image\//i.test(u)) return true;
    if (/^(https?:)?\/\//i.test(u)) {
      return /\.(png|jpe?g|gif|webp|svg)(\?.*)?$/i.test(u);
    }
    return false;
  }
  function shouldPreviewFor(key, value){
    const k = String(key || '').toLowerCase();
    const keyLooksImage =
      /\b(img|image|thumbnail|thumb|icon|logo|background|bg|poster)\b/.test(k) ||
      /(^|_|-)imgsrc$/.test(k) ||
      /(^|_|-)src$/.test(k);
    return isLikelyImageUrl(value) || (keyLooksImage && typeof value === 'string' && value.trim() !== '');
  }


  function extractArrayLiteral(src){
    const first = src.indexOf('[');
    if (first === -1) return null;
    let depth = 0, inStr = false, strQ = '', esc = false;
    for (let i = first; i < src.length; i++){
      const ch = src[i];
      if (inStr){
        if (esc){ esc = false; continue; }
        if (ch === '\\') { esc = true; continue; }
        if (ch === strQ) inStr = false;
      } else {
        if (ch === '"' || ch === "'"){ inStr = true; strQ = ch; }
        else if (ch === '[') depth++;
        else if (ch === ']'){
          depth--;
          if (depth === 0) return src.slice(first, i+1);
        }
      }
    }
    return null;
  }
  function loadConfig() {
    try {
      const raw = document.getElementById('inputConfig').value || '';
      const allowUnsafe = document.getElementById('allowUnsafe').checked;

      const match = raw.match(/(window\.[A-Za-z_$][\w$]*\s*=|const\s+[A-Za-z_$][\w$]*\s*=|let\s+[A-Za-z_$][\w$]*\s*=|var\s+[A-Za-z_$][\w$]*\s*=|[A-Za-z_$][\w$]*\s*=)/);
      originalAssignment = match ? match[0].trim() : 'const config =';

      const arrayCode = extractArrayLiteral(raw);
      if (!arrayCode) throw new Error("Failed to find an array.");

      let parsed;
      try {
        parsed = JSON.parse(arrayCode);
      } catch (e) {
        if (!allowUnsafe) throw new Error("Looks like a JS literal, not JSON. Enable 'Allow unsafe JS literal parsing'.");
        parsed = (new Function('"use strict";return (' + arrayCode + ')'))();
      }
      if (!Array.isArray(parsed)) throw new Error("Found code is not an array.");
      config = parsed;
      renderConfig();
    } catch (err) {
      alert("Load error: " + err.message);
    }
  }
  function toLiteral(val){
    if (val === undefined) return 'undefined';
    if (typeof val === 'string') {
      return '"' + val
        .replace(/\\/g, '\\\\').replace(/"/g, '\\"')
        .replace(/\r/g, '\\r').replace(/\n/g, '\\n') + '"';
    }
    if (typeof val === 'number' || typeof val === 'boolean' || val === null) return String(val);
    if (Array.isArray(val)) return '[' + val.map(v => toLiteral(v)).join(', ') + ']';
    if (isObj(val)){
      const body = Object.entries(val).map(([k,v]) => {
        const keyStr = isValidIdentifier(k) ? k : JSON.stringify(k);
        return `${keyStr}: ${toLiteral(v)}`;
      }).join(', ');
      return `{ ${body} }`;
    }
    return 'null';
  }
  function exportConfig() {
    try {
      const output = document.getElementById('outputConfig');
      const assign = /=$/.test(originalAssignment.trim()) ? originalAssignment.trim() : (originalAssignment.trim() + ' =');
      const body = config.map(obj => {
        const entries = Object.entries(obj).map(([key, val]) => {
          const safeKey = isValidIdentifier(key) ? key : JSON.stringify(key);
          const safeVal = toLiteral(val);
          return `  ${safeKey}: ${safeVal}`;
        }).join(',\n');
        return '  {\n' + entries + '\n  }';
      }).join(',\n');
      output.value = assign + ' [\n' + body + '\n];';
    } catch (e) { alert('Export error: ' + (e?.message || e)); }
  }


  function renderConfig() {
    const container = document.getElementById('configContainer');
    container.innerHTML = '';

    // top-level list with DnD
    config.forEach((obj, index) => {
      const wrap = document.createElement('div');
      wrap.className = 'top-item-wrap array-item';
      wrap.dataset.index = index;

      const handle = document.createElement('span');
      handle.className = 'drag-handle';
      handle.textContent = '⇅';
      wrap.appendChild(handle);

      const card = document.createElement('div');
      card.className = 'entry';
      card.appendChild(renderValue(obj, [index], `Item ${index+1}`));

      const strip = document.createElement('div');
      strip.className = 'controls';
      const dupBtn = document.createElement('button');
      dupBtn.className = 'small ghost';
      dupBtn.textContent = 'Duplicate item';
      dupBtn.onclick = () => { config.splice(index+1,0,deepClone(config[index])); renderConfig(); };
      const removeObjBtn = document.createElement('button');
      removeObjBtn.className = 'small danger';
      removeObjBtn.textContent = 'Delete item';
      removeObjBtn.onclick = () => { config.splice(index, 1); renderConfig(); };
      strip.appendChild(dupBtn);
      strip.appendChild(removeObjBtn);
      card.appendChild(strip);

      wrap.appendChild(card);
      container.appendChild(wrap);
    });

    // wire DnD for top-level
    setupDnDForList(
      document.getElementById('configContainer'),
      config,
      'top'
    );
  }

  function renderValue(value, path, labelText){
    const wrap = document.createElement('div');

    if (value === null || typeof value !== 'object'){
      const row = document.createElement('div');
      row.className = 'row';

      const col = document.createElement('div');
      col.className = 'grow';

      const label = document.createElement('label');
      label.textContent = prettyLabel(labelText);

      const input = document.createElement('input');
      input.value = value ?? '';

      const lastKey = path[path.length - 1];
      const wantPreview = shouldPreviewFor(lastKey, value);
      let img = null;

      input.addEventListener('input', e => {
        const raw = e.target.value;
        const next = smartCoerce(raw);
        setByPath(config, path, next);
        if (img){
          if (typeof raw === 'string' && raw.trim() !== ''){
            img.src = raw;
            img.style.display = '';
          } else {
            img.style.display = 'none';
          }
        }
      });

      col.appendChild(label);
      col.appendChild(input);
      row.appendChild(col);

      if (wantPreview){
        img = document.createElement('img');
        img.src = (typeof value === 'string' && value.trim() !== '') ? value : '';
        img.className = 'preview';
        if (!img.src) img.style.display = 'none';
        row.appendChild(img);
      }

      const del = document.createElement('button');
      del.textContent = 'Delete';
      del.className = 'small danger';
      del.onclick = () => { deleteByPath(config, path); renderConfig(); };
      row.appendChild(del);

      wrap.appendChild(row);
      return wrap;
    }


    if (Array.isArray(value)){
      const det = document.createElement('details');
      det.open = true;
      const sum = document.createElement('summary');
      sum.innerHTML = `${prettyLabel(labelText)} <span class="badge">${value.length} items</span>`;
      det.appendChild(sum);

      const list = document.createElement('div');
      list.className = 'array-list';
      det.appendChild(list);

      value.forEach((item, i) => {
        const itemWrap = document.createElement('div');
        itemWrap.className = 'array-item';
        itemWrap.dataset.index = i;

        const h = document.createElement('span');
        h.className = 'drag-handle';
        h.textContent = '⇅';
        itemWrap.appendChild(h);

        const child = renderValue(item, path.concat(i), `Item ${i+1}`);
        child.style.marginLeft = '0';
        itemWrap.appendChild(child);

        const ctr = document.createElement('div');
        ctr.className = 'controls';
        const dup = document.createElement('button');
        dup.className = 'small ghost';
        dup.textContent = 'Duplicate';
        dup.onclick = () => { value.splice(i+1,0,deepClone(item)); renderConfig(); };
        const del = document.createElement('button');
        del.className = 'small danger';
        del.textContent = 'Delete';
        del.onclick = () => { deleteByPath(config, path.concat(i)); renderConfig(); };
        ctr.appendChild(dup);
        ctr.appendChild(del);
        itemWrap.appendChild(ctr);

        list.appendChild(itemWrap);
      });

      setupDnDForList(list, value, pathKeyOf(path));

      const addCtr = document.createElement('div');
      addCtr.className = 'controls';

      const addSimilar = document.createElement('button');
      addSimilar.className = 'small ok';
      addSimilar.textContent = 'Add similar';
      addSimilar.onclick = () => {
        const template = value.length ? cloneShapeLike(value[value.length-1]) : '';
        value.push(template);
        renderConfig();
      };

      const typeSel = document.createElement('select');
      ['string','number','boolean','object','array','null'].forEach(t => {
        const opt = document.createElement('option'); opt.value = t; opt.textContent = t;
        typeSel.appendChild(opt);
      });
      const addAs = document.createElement('button');
      addAs.className = 'small ghost';
      addAs.textContent = 'Add as…';
      addAs.onclick = () => { value.push(makeByType(typeSel.value)); renderConfig(); };

      const delSelf = document.createElement('button');
      delSelf.className = 'small danger';
      delSelf.textContent = 'Delete array';
      delSelf.onclick = () => { deleteByPath(config, path); renderConfig(); };

      addCtr.appendChild(addSimilar);
      addCtr.appendChild(typeSel);
      addCtr.appendChild(addAs);
      addCtr.appendChild(delSelf);

      det.appendChild(addCtr);
      wrap.appendChild(det);
      return wrap;
    }

    // object
    const det = document.createElement('details');
    det.open = true;
    const sum = document.createElement('summary');
    sum.textContent = prettyLabel(labelText);
    det.appendChild(sum);

    Object.keys(value).forEach(k => {
      const child = renderValue(value[k], path.concat(k), k);
      child.style.marginLeft = '12px';
      det.appendChild(child);

      // per-field delete
      const ctr = document.createElement('div');
      ctr.className = 'controls';
     
      det.appendChild(ctr);
    });

    // add field
    const addKey = document.createElement('div');
    addKey.className = 'keyAdd';
    const keyInput = document.createElement('input');
    keyInput.placeholder = 'New field name';
    keyInput.style.maxWidth = '220px';
    const addBtn = document.createElement('button');
    addBtn.className = 'small ok';
    addBtn.textContent = 'Add field';
    addBtn.onclick = () => {
      const base = keyInput.value.trim() || 'newKey';
      const unique = ensureUniqueKey(value, base);
      value[unique] = '';
      keyInput.value = '';
      renderConfig();
    };
    const delObj = document.createElement('button');
    delObj.className = 'small danger';
    delObj.textContent = 'Delete object';
    delObj.onclick = () => { deleteByPath(config, path); renderConfig(); };

    addKey.appendChild(keyInput);
    addKey.appendChild(addBtn);
    addKey.appendChild(delObj);
    det.appendChild(addKey);

    wrap.appendChild(det);
    return wrap;
  }

  function setupDnDForList(listEl, arrRef, pathKey){
    const items = Array.from(listEl.children).filter(el => el.classList.contains('array-item'));
    items.forEach((el, idx) => {
      el.draggable = true;
      el.dataset.index = idx;

      el.addEventListener('dragstart', (e) => {
        dragCtx = { pathKey, fromIndex: idx };
        el.classList.add('dragging');
        try { e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain',''); } catch {}
      });
      el.addEventListener('dragend', () => {
        el.classList.remove('dragging', 'drop-before', 'drop-after');
        dragCtx = null;
      });
      el.addEventListener('dragover', (e) => {
        if (!dragCtx || dragCtx.pathKey !== pathKey) return;
        e.preventDefault();
        const rect = el.getBoundingClientRect();
        const overBottom = e.clientY > rect.top + rect.height/2;
        el.classList.toggle('drop-before', !overBottom);
        el.classList.toggle('drop-after', overBottom);
      });
      el.addEventListener('dragleave', () => {
        el.classList.remove('drop-before', 'drop-after');
      });
      el.addEventListener('drop', (e) => {
        if (!dragCtx || dragCtx.pathKey !== pathKey) return;
        e.preventDefault();
        const from = dragCtx.fromIndex;
        const toBase = Number(el.dataset.index);
        const rect = el.getBoundingClientRect();
        const overBottom = e.clientY > rect.top + rect.height/2;
        let to = overBottom ? toBase + 1 : toBase;
        if (from < to) to -= 1;
        moveInArray(arrRef, from, to);
        renderConfig();
      });
    });
  }

  function addTopLevelItem(){
    const basis = config[config.length-1];
    config.push(basis ? cloneShapeLike(basis) : {});
    renderConfig();
  }

  document.getElementById('copy').addEventListener('click', () => {
    const text = document.getElementById('outputConfig').value;
    navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'))
      .catch(err => alert('Copy error: ' + err));
  });
  document.getElementById('loadBtn').addEventListener('click', loadConfig);
  document.getElementById('exportBtn').addEventListener('click', exportConfig);
  document.getElementById('addItemBtn').addEventListener('click', addTopLevelItem);
</script>
</body>
</html>
